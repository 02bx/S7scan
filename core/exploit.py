#!/usr/bin/env python		
#coding:utf-8

import os 
import sys 
import imp
from data import output,queue,paths

reload(sys)
sys.setdefaultencoding('gbk')


def loadScript(file):
	#print path,file
	fp, pathname, description = imp.find_module(file, [paths['SCRIPT_PATH']])
	#print fp,pathname,description
	try:
		module_obj = imp.load_module("_",fp,pathname,description)
		return module_obj
	except Exception,e:
		#print e
		print 'the poc dose not exist or error'



def loadTargets(args): #
	#argument不能同时出现
	if (args.u and args.f) or (args.u and args.m) or (args.f and args.m):  
		output.error('duplicate arguments...')
		sys.exit()

	# 分别对url,file,mask这三种类型的参数做解析处理，放入queue中
	if args.u:
		u = args.u
		if u.startswith('http://') or u.startswith('https://'):  #对ip进行统一净化 
			queue.put(u.strip())
		else:
			u = 'http://'+u
			queue.put(u.strip())
		
	if args.f:
		with open(args.f) as f:
			for u in f:
				if u.startswith('http://') or u.startswith('https://'):
					queue.put(u.strip())
				else:
					u = 'http://'+u
					queue.put(u.strip())

	if args.m:
		mask_ip = MaskFix(args.m)
		mask = 32- int(mask_ip.split('/')[-1])
		netaddr = mask_ip.rpartition('.')[0] #利用rpartition分割更加快
		for i in range(2**mask):
			ip = 'http://'+netaddr +'.'+str(i)
			#print ip
			queue.put(ip)

	return queue




def MaskFix(Mask):
	if 'http://' in Mask or 'https://' in Mask:
		Mask = Mask.replace('http://','').replace('https://','')
	
	if '/' in Mask:
		return Mask 
	else:
		return Mask+'/24'